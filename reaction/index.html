<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reaction Time</title>
  <link rel="stylesheet" href="styles.css">
  <link href='http://fonts.googleapis.com/css?family=Raleway:400,900' rel='stylesheet' type='text/css'>
</head>
<body>
  <div class="text top"><p>This is a</p><p>reaction</p><p>game</p></div>
  <div id="container">
    <div id="blocker">
      <p class="warning top">Bad!</p>
      <p id="ms"></p>
      <p class="warning bottom">The box wasn't red.</p>
      <div id="innerblocker"></div>
    </div>
  </div>
  <div class="text bottom"><p>Hit</p><p>space</p><p id="instructions">to start</p></div>

  <script>
    var stepTime, currentLink, nextStep, paused = true, busy = false;
    var container = document.querySelector('#container');
    var blocker = document.querySelector('#blocker');
    var ms = document.querySelector('#ms');
    var instructions = document.querySelector('#instructions');
    var urls = [], categories = {};

    function populate(sites) {
      containerChildren = [blocker];

      function appendLink(url, categories) {
        var element = document.createElement('a');
        element.href = url;
        element.setAttribute('data-categories', categories.join(' '));
        containerChildren.push(container.insertBefore(element, containerChildren[ Math.ceil(Math.random() * containerChildren.length) ]));
      }

      for (var site in sites) {
        if (sites.hasOwnProperty(site)) {
          appendLink(site, sites[site]);
        }
      }

    }

    function step(duration) {
      var timeUntilNext, index, children;
      stepTime = new Date().getTime();

      if (currentLink) {
        container.removeChild(currentLink);
      }

      if (duration > 10000) {
        nextStep = currentLink = false;
        blocker.className = 'dummy';
      } else {
        children = container.children;
        index = children.length - 1;

        if (index) {
          currentLink = children[ index ];
        } else currentLink = false;

        // run it again in [800, 1000)ms
        timeUntilNext = Math.floor((Math.random() * 200) + 800);
        nextStep = window.setTimeout(function() {
          step(duration + timeUntilNext);
        }, timeUntilNext);
      }
    }

    function start() {
      function countdown(stage) {
        if (stage) {
          ms.textContent = stage;
          window.setTimeout(function() {
            countdown(stage - 1);
          }, 500);
        } else {
          ms.textContent = 'GO';
          window.setTimeout(function() {
            blocker.className = '';
            ms.textContent = '';
            busy = false;
            step(0);
          }, 500);
        }
      }
      busy = true;
      blocker.className = 'blocking';
      countdown(3);
    }

    function handleKeydown(e) {
      var key = e.key || e.keyCode;

      if (!busy && key === 32) {
        if (paused) {
          paused = false;
          instructions.textContent = "when red";
          start();
        } else {
          if (nextStep) {
            window.clearTimeout(nextStep);
            blocker.className = 'non-blocking';
            urls.push(currentLink.href);
            currentLink.getAttribute('data-categories').split(' ').forEach(function(category) {
              if (categories[category] === undefined) {
                categories[category] = 1;
              } else ++categories[category];
            });
          }
          instructions.textContent = "to retry";
          paused = true;
          ms.innerText = new Date().getTime() - stepTime + 'ms';
        }
      } else if (key === 65) {
        // prevent meta + a for select all
        e.preventDefault();
        return false;
      }
    }

    var request = new XMLHttpRequest();

    request.open('GET', '../sites.json', true);

    request.onload = function() {
      if (request.status >= 200 && request.status < 400){
        var sites = JSON.parse(request.responseText);
        populate(sites);
        window.addEventListener('keydown', handleKeydown, false);
      }
    };

    request.send();
  </script>
</body>
</html>